<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة الرسوم - صفحة الخدمات</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#1f2937;--text:#e5e7eb;--sub:#94a3b8;--accent:#22c55e;--accent2:#16a34a}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .container{max-width:980px;margin:0 auto;padding:20px}
    h1{font-size:26px;margin:0 0 6px 0}
    .sub{color:var(--sub);margin-bottom:16px}
    .card{background:var(--card);border:1px solid var(--muted);border-radius:16px;padding:16px;margin-bottom:16px}
    label{display:block;margin:8px 0 6px}
    input, select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--muted);background:#0b1220;color:var(--text)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{padding:12px 14px;border-radius:12px;border:1px solid var(--accent2);background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;color:var(--text);border-color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--muted);padding:10px;text-align:right}
    .ok{color:#a7f3d0;font-weight:800}
    .danger{color:#fca5a5;font-weight:700}
    .hidden{display:none}
    .receipt{width:100%; max-width:750px; margin:0 auto; background:#fff; color:#000; padding:20px; border-radius:12px}
    .receipt h2{margin:0 0 10px 0; font-size:22px}
    .rrow{display:flex;justify-content:space-between;margin:6px 0}
    .line{border-top:1px dashed #999; margin:10px 0}
    .stamp{border:2px solid #111; padding:6px 10px; display:inline-block; font-weight:800}
    @media print{ body{background:#fff;color:#000} .no-print{display:none !important} .receipt{box-shadow:none; border:0; padding:0} }
  </style>
</head>
<body>
  <div class="container">
    <h1>صفحة الخدمات</h1>
    <div class="sub">اختر خدمة من القائمة، احسب الرسوم، ثم اطبع الإيصال PDF مشابه لتنسيق الشيت.</div>

    <div class="card">
      <div class="row">
        <div>
          <label for="start">تاريخ البداية</label>
          <input id="start" type="date" value="2024-01-17"/>
        </div>
        <div>
          <label for="service">الخدمة</label>
          <select id="service"></select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label for="mode">طريقة الحساب</label>
          <select id="mode">
            <option value="quarter" selected>تقريب لأقرب ربع (CEILING)</option>
            <option value="daily">أدق (باليوم)</option>
          </select>
        </div>
        <div>
          <label for="client">اسم العميل (للإيصال)</label>
          <input id="client" placeholder="مثال: شركة س" />
        </div>
      </div>

      <div class="btns no-print" style="margin-top:12px">
        <button id="calc">احسب الآن</button>
        <button id="print" class="secondary">حفظ الإيصال PDF</button>
      </div>
    </div>

    <div id="results" class="card hidden"></div>

    <div id="receipt-wrap" class="card hidden">
      <div class="receipt" id="receipt">
        <h2>إيصال سداد خدمات</h2>
        <div class="rrow"><span>اسم العميل:</span><b id="rc-client">—</b></div>
        <div class="rrow"><span>الخدمة:</span><b id="rc-service">—</b></div>
        <div class="rrow"><span>فترة الاحتساب:</span><b><span id="rc-start">—</span> → <span id="rc-end">—</span></b></div>
        <div class="rrow"><span>عدد الأيام:</span><b id="rc-days">—</b></div>
        <div class="rrow"><span>أساس الرسوم:</span><b id="rc-basis">تقريب لأقرب ربع</b></div>
        <div class="line"></div>
        <div class="rrow"><span>عدد الأرباع/القيمة اليومية:</span><b id="rc-mult">—</b></div>
        <div class="rrow"><span>قيمة السنة:</span><b id="rc-yearly">—</b></div>
        <div class="rrow"><span>المبلغ المستحق:</span><b id="rc-amount">—</b></div>
        <div class="line"></div>
        <div class="rrow"><span>تاريخ الإصدار:</span><b id="rc-issued">—</b></div>
        <div class="rrow"><span>إمضاء/ختم:</span><b class="stamp">PAID</b></div>
      </div>
    </div>
  </div>

  <script>
    const SERVICES = [{"name": "إصدار ترخيص / تجديد ترخيص \nبمزاولة أحد أنشطة النقل البري للبضائع .", "yearly": 5000.0}, {"name": "إصدار ترخيص/ تجديد ترخيص مزاولة نشاط وسيط الشحن للنقل البري للبضائع (داخلي / دولي).", "yearly": 1250.0}, {"name": "إصدار ترخيص/ تجديد ترخيص مزاولة نشاط وسيط الشحن للنقل البري للبضائع باستخدام تكنولوجيا المعلومات.", "yearly": 2500.0}, {"name": "إصدار ترخيص / تجديد ترخيص مزاولة نشاط النقل البري للبضائع بإستخدام تكنولوجيا المعلومات.", "yearly": 2500.0}, {"name": "الموافقة على ترخيص فرع لشركة  لمزاولة نشاط النقل البري للبضائع.", "yearly": 500.0}, {"name": "إصدار ترخيص / تجديد ترخيص بمزاولة نشاط النقل البري متعدد الوسائط.", "yearly": 2500.0}, {"name": "إصدار ترخيص / تجديد ترخيص بمزاولة نشاط النقل البري لنقل وتداول الحاويات.", "yearly": 2500.0}, {"name": "إصدار ترخيص / تجديد ترخيص بمزاولة نشاط النقل البري للبضائع الخطرة.", "yearly": 2500.0}, {"name": " إصدار بطاقة  تشغيل لوسائل النقل البري للبضائع بأجرسيارات ذات وزن أقل من (8) طناً.", "yearly": 150.0}, {"name": " إصدار بطاقة  تشغيل لوسائل النقل البري للبضائع بأجرسيارات ذات وزن قائم من (8) طن إلى (20) طن.", "yearly": 2000.0}, {"name": " إصدار بطاقة  تشغيل لوسائل النقل البري للبضائع بأجرسيارات ذات وزن قائم أكبر من (20) طن.", "yearly": 500.0}, {"name": " إصدار أو تجديد بطاقة  تشغيل \nلوسيلة النقل البري الذاتي للبضائع - سنوياً سيارات ذات وزن أقل من (8) طناً.", "yearly": 75.0}, {"name": " إصدار أو تجديد بطاقة  تشغيل \nلوسيلة النقل البري الذاتي للبضائع - سنوياً سيارات ذات وزن قائم من (8) طن إلى (30) طن", "yearly": 100.0}, {"name": " إصدار أو تجديد بطاقة  تشغيل \nلوسيلة النقل البري الذاتي للبضائع - سنوياً سيارات ذات وزن قائم أكبر من (30) طن.", "yearly": 125.0}];

    const BASELINE = new Date(Date.UTC(2022,10,22)); // 2022-11-22
    const $ = sel => document.querySelector(sel);
    const results = $('#results');
    const rwrap = $('#receipt-wrap');

    function toISODateUTC(d){ return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString().slice(0,10); }
    function daysBetweenUTC(a,b){ const MS = 86400000; const au = Date.UTC(a.getUTCFullYear(), a.getUTCMonth(), a.getUTCDate()); const bu = Date.UTC(b.getUTCFullYear(), b.getUTCMonth(), b.getUTCDate()); return Math.round((bu-au)/MS); }
    function ceilQuartersFromDays(days){ const years = days/365; return Math.ceil(years*4); }

    // populate services
    const sel = $('#service');
    SERVICES.forEach(s => { const opt = document.createElement('option'); opt.value = s.name; opt.textContent = `${s.name} — ${s.yearly}/سنة`; sel.appendChild(opt); });

    function compute(){
      const startVal = $('#start').value;
      const sName = $('#service').value;
      const client = $('#client').value || '—';
      const mode = $('#mode').value;

      if(!startVal){ alert('اختر تاريخ البداية'); return; }
      if(!sName){ alert('اختر خدمة'); return; }

      const service = SERVICES.find(x=>x.name===sName);
      const sd = new Date(startVal + 'T00:00:00');
      const start = (new Date(Date.UTC(sd.getFullYear(), sd.getMonth(), sd.getDate())));
      const startClamped = (start.getTime() <= BASELINE.getTime()) ? BASELINE : start;

      const now = new Date();
      const yestUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()-1));

      const days = daysBetweenUTC(startClamped, yestUTC);
      if(days < 0){ results.classList.remove('hidden'); results.innerHTML='<div class="danger">تاريخ البداية لاحق ليوم أمس</div>'; rwrap.classList.add('hidden'); return; }

      const yearly = Number(service.yearly);
      const perQuarter = yearly/4;
      const quarters = ceilQuartersFromDays(days);
      const byQuarter = quarters * perQuarter;
      const exactDaily = (yearly * days) / 365;

      const amount = (mode==='quarter') ? byQuarter : exactDaily;
      const basis = (mode==='quarter') ? 'تقريب لأقرب ربع' : 'حساب أدق (باليوم)';

      results.classList.remove('hidden');
      results.innerHTML = `
        <h3>النتائج</h3>
        <table>
          <tr><th>الخدمة</th><td>${sName}</td></tr>
          <tr><th>بداية العد</th><td>${toISODateUTC(startClamped)}</td></tr>
          <tr><th>حتى (اليوم - 1)</th><td>${toISODateUTC(yestUTC)}</td></tr>
          <tr><th>عدد الأيام</th><td>${days}</td></tr>
          <tr><th>قيمة السنة</th><td>${yearly.toLocaleString()}</td></tr>
          <tr><th>عدد الأرباع (بعد التقريب)</th><td>${quarters}</td></tr>
          <tr><th>المبلغ (بالربع)</th><td class="ok">${byQuarter.toFixed(2)}</td></tr>
          <tr><th>المبلغ (باليوم)</th><td class="ok">${exactDaily.toFixed(2)}</td></tr>
        </table>
      `;

      rwrap.classList.remove('hidden');
      $('#rc-client').textContent = client;
      $('#rc-service').textContent = sName;
      $('#rc-start').textContent = toISODateUTC(startClamped);
      $('#rc-end').textContent = toISODateUTC(yestUTC);
      $('#rc-days').textContent = days;
      $('#rc-basis').textContent = basis;
      $('#rc-mult').textContent = (mode==='quarter') ? (quarters + ' ربع') : (days + ' يوم');
      $('#rc-yearly').textContent = yearly.toLocaleString();
      $('#rc-amount').textContent = amount.toFixed(2);
      $('#rc-issued').textContent = new Date().toLocaleString('ar-EG');
    }

    $('#calc').addEventListener('click', compute);
    $('#print').addEventListener('click', ()=>{ window.print(); });
  </script>
</body>
</html>
